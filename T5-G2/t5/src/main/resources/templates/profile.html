<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <div th:replace="fragments/header :: header"></div>
    <link rel="stylesheet" href="/t5/css/profile.css"/>
    <title>Profile</title>
</head>
<body>
<!-- NAVBAR -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="main-container">
    <span id="user-exp" hidden th:text="${userCurrentExperience}"></span>

    <div class="header-row">
        <h1 class="page-title">Profilo</h1>

        <div class="header-controls">
            <div class="dropdown-wrapper">
                <button id="soundMenuBtn" class="btn-outline small icon-only" onclick="toggleSoundMenu()">
                    <i class="bi bi-volume-up" id="mainSoundIcon"></i>
                </button>
                <div id="soundDropdown" class="custom-dropdown sound-dropdown">
                    <div class="sound-toggle-row" onclick="toggleMuteState()">
                        <span id="soundStatusText">Audio: ON</span>
                        <i class="bi bi-toggle-on" id="soundToggleIcon"></i>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-label">Pacchetto Suoni</div>
                    <div class="sound-options-list">
                        <div class="sound-item active" id="opt_spartan" onclick="setSoundProfile('spartan')"><i class="bi bi-shield-alt"></i> Spartan</div>
                        <div class="sound-item" id="opt_covenant" onclick="setSoundProfile('covenant')"><i class="bi bi-globe-asia"></i> Covenant</div>
                        <div class="sound-item" id="opt_retro" onclick="setSoundProfile('retro')"><i class="bi bi-gamepad"></i> 8-Bit</div>
                        <div class="sound-item" id="opt_heavy" onclick="setSoundProfile('heavy')"><i class="bi bi-cog"></i> Heavy</div>
                    </div>
                </div>
            </div>

            <div class="dropdown-wrapper">
                <button id="notifBtn" class="btn-outline small icon-only" onclick="toggleNotifications()">
                    <i class="bi bi-bell"></i>
                    <span class="header-badge" id="notifBadge" style="display: none;">0</span>
                </button>
                <div id="notifDropdown" class="custom-dropdown notif-dropdown">
                    <div class="dropdown-header">Richieste in attesa</div>
                    <ul id="notifList" class="notif-list"><li class="notif-empty">Nessuna nuova notifica.</li></ul>
                </div>
            </div>

            <button id="backToMeBtn" class="btn-outline small hidden" onclick="loadProfile('me')"><i class="bi bi-undo"></i> Profilo</button>
        </div>
    </div>

    <div class="dashboard-grid">

        <div class="col-left">
            <div class="card profile-card">
                <div class="avatar-container">
                    <img src="" alt="Avatar" id="profileImage">
                    <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">
                    <button class="edit-avatar-btn" id="editAvatarBtn" title="Cambia foto"><i class="bi bi-camera"></i></button>
                    <div class="status-dot online" id="profileStatusDot"></div>
                </div>
                <h2 class="username" id="profileName">...</h2>
                <span class="role-badge" id="profileTag">...</span>
                <div class="profile-actions" id="profileActions"></div>
                <div class="bio-section">
                    <div class="bio-header"><span class="bio-label">SERVICE RECORD</span><button id="editBioBtn" class="edit-bio-btn"><i class="bi bi-pen"></i></button></div>
                    <p class="bio-text" id="bioText">...</p>
                    <textarea id="bioInput" class="bio-textarea" style="display: none;"></textarea>
                </div>
            </div>

            <div class="card rank-card">
                <div class="rank-header">
                    <div class="rank-icon-container clickable" id="rankIconContainer">
                        <img id="rankImage" src="" alt="Rank Icon" onerror="this.style.display='block'; document.getElementById('rankFallback').style.display='flex';">
                        <div id="rankFallback" class="rank-patch" style="display:none;"><i id="rankFallbackIcon" class="bi bi-user"></i></div>
                        <div class="icon-hover-overlay"><i class="bi bi-list"></i></div>
                    </div>
                    <div class="rank-titles">
                        <span class="rank-label">Grado Attuale</span>
                        <h3 id="currentRankName">...</h3>
                    </div>
                </div>
                <div class="rank-progress-section">
                    <div class="rank-info-row"><span id="currentCredits">0 cR</span><span id="nextRankCredits" class="text-muted">...</span></div>
                    <div class="progress-bar-container large"><div class="progress-bar-fill rank-fill" id="rankProgressBar" style="width: 0%;"></div></div>
                    <p class="rank-message" id="rankMessage">...</p>
                </div>
            </div>
        </div>

        <div class="col-main">

            <div class="main-tabs-container">
                <button class="main-tab-btn active" onclick="switchMainView('game')"><i class="bi bi-crosshairs"></i> PARTITE</button>
                <button class="main-tab-btn" onclick="switchMainView('social')"><i class="bi bi-globe"></i> SOCIAL</button>
            </div>

            <div id="view-game" class="view-section active">
                <div class="game-top-row">
                    <div class="card chart-card">
                        <h3><i class="bi bi-chart-radar"></i> Competenze</h3>
                        <div class="chart-container"><canvas id="skillsChart"></canvas></div>
                    </div>
                    <div class="card stats-card">
                        <h3><i class="bi bi-chart-bar"></i> Statistiche</h3>
                        <div class="stats-grid">
                            <div class="stat-box"><span class="stat-label">Tests</span><span class="stat-value big-accent" id="statTests">1.2k</span></div>
                            <div class="stat-box"><span class="stat-label">Fixes</span><span class="stat-value text-win" id="statFixes">300</span></div>
                            <div class="stat-box"><span class="stat-label">Numero Partite</span><span class="stat-value" id="statKD">10</span></div>
                            <div class="stat-box"><span class="stat-label">Ore</span><span class="stat-value" id="statHours">480</span></div>
                        </div>
                    </div>
                </div>
                <div class="card activity-card">
                    <h3 class="section-title"><i class="bi bi-history"></i> Ultime Partite</h3>
                    <ul class="match-list" id="matchListArea"></ul>
                </div>
            </div>

            <div id="view-social" class="view-section" style="display: none;">
                <div class="card social-hub-card">
                    <h3><i class="bi bi-satellite-dish"></i>Social</h3>
                    <div class="search-bar-container">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="socialSearchInput" placeholder="Cerca..." onkeyup="filterSocialList()">
                    </div>
                    <div class="social-tabs">
                        <button class="tab-btn active" onclick="switchSocialTab('friends')"><i class="bi bi-user-friends"></i> Amici</button>
                        <button class="tab-btn" onclick="switchSocialTab('suggestions')"><i class="bi bi-user-plus"></i> Suggeriti</button>
                    </div>
                    <div id="friendsList" class="social-list-container active"><ul class="social-list" id="ulFriends"></ul></div>
                    <div id="suggestionsList" class="social-list-container" style="display: none;"><ul class="social-list" id="ulSuggestions"></ul></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALI -->
<div id="rankModal" class="modal-overlay">
    <div class="modal-window">
        <div class="modal-header">
            <h2>Gradi Spartan</h2>
            <button class="close-modal" onclick="closeRankModal()"><i class="bi bi-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="rank-summary-box">
                <p id="modalNextGoalText">...</p>
                <div class="progress-bar-container large"><div class="progress-bar-fill rank-fill" id="modalProgressBar" style="width: 0%;"></div></div>
            </div>
            <div class="rank-list-container"><ul class="full-rank-list" id="fullRankList"></ul></div>
        </div>
    </div>
</div>

<div id="avatarPickerModal" class="modal-overlay">
    <div class="modal-window">
        <div class="modal-header">
            <h2>Scegli il tuo avatar</h2>
            <button class="close-modal" onclick="closeAvatarModal()"><i class="bi bi-times"></i></button>
        </div>

        <div class="modal-body">
            <div id="avatarList" class="avatar-list"></div>
        </div>
    </div>
</div>


<div id="rematchModal" class="modal-overlay">
    <div class="modal-window small-modal">
        <div class="modal-header warning-header">
            <h2><i class="bi bi-exclamation-triangle"></i> Sfida</h2>
            <button class="close-modal" onclick="closeRematchModal()"><i class="bi bi-times"></i></button>
        </div>
        <div class="modal-body center-content">
            <p class="rematch-text">Vuoi sfidare di nuovo:</p>
            <h2 id="rematchOpponentName" class="opponent-name">OPPONENT</h2>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeRematchModal()">No</button>
                <button class="btn-modal btn-confirm" onclick="confirmRematch()">Sì</button>
            </div>
        </div>
    </div>
</div>

<!-- CHAT WIDGET -->
<div class="chat-widget">
    <button class="chat-toggle-btn" onclick="toggleChatWidget()"><i class="bi bi-comment-dots"></i><span class="notification-badge" id="chatBadge" style="display: none;">0</span></button>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="header-left">
                <button id="chatBackBtn" class="chat-back-btn" onclick="showContactList()" style="display: none;"><i class="bi bi-chevron-left"></i></button>
                <div class="header-title-container">
                    <span id="chatHeaderTitle" class="chat-header-title">Comms Link</span>
                    <span id="chatHeaderStatus" class="chat-header-status">Online</span>
                </div>
            </div>
            <button class="close-chat" onclick="toggleChatWidget()"><i class="bi bi-times"></i></button>
        </div>
        <div class="chat-body-container">
            <div id="chatContactList" class="chat-view active"></div>
            <div id="chatConversation" class="chat-view" style="display: none;">
                <div id="chatRequestBar" class="chat-request-bar" style="display: none;"><span class="req-text">Non è tra gli amici.</span><div class="req-actions"><button class="req-btn accept" onclick="acceptChatRequest()">Accetta</button><button class="req-btn block" onclick="blockChatUser()">Blocca</button></div></div>
                <div class="messages-area" id="messagesArea"></div>
                <div class="chat-input-area"><input type="text" id="msgInput" placeholder="Scrivi..." onkeypress="handleEnter(event)"><button class="send-msg-btn" onclick="sendMessage()"><i class="bi bi-paper-plane"></i></button></div>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script src="/t5/js/profile.js"></script>

</body>
</html>
